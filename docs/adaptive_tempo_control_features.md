# 適応的テンポ制御機能の詳細仕様書

## 概要

本アプリに実装された適応的テンポ制御機能は、個々のユーザーの歩行特性を学習し、無意識的な歩行誘導を実現するための機能群です。

## 主要機能

### 1. 個人パラメータ学習システム

#### 機能概要
実験セッションのデータから個人の歩行特性を学習し、最適なパラメータを自動調整します。

#### 学習されるパラメータ

1. **反応性スコア (Responsiveness Score)**
   - 範囲: 0.5 - 2.0
   - 音刺激への反応速度を表す
   - テンポ変更後90%以上の追従率に達するまでの時間から算出
   - 反応時間が短いほどスコアが高い

2. **安定性重視度 (Stability Preference)**
   - 範囲: 0.5 - 2.0
   - 歩行の安定性を重視する傾向を表す
   - 平均CV値から算出
   - CV値が低いほど安定性を重視する傾向が高い

3. **最大快適SPM (Max Comfortable SPM)**
   - ベースラインSPMの110-115%程度
   - CV値が0.05未満で安定して歩行できた最大SPMから算出

#### 実装詳細

```dart
// 反応性の学習アルゴリズム
void learnFromSession(List<Map<String, dynamic>> sessionData) {
  // テンポ変更時点を検出
  // 90%追従率達成までの時間を測定
  // 平均反応時間から反応性スコアを算出
}
```

### 2. CV（変動係数）トレンドチャート

#### 機能概要
歩行の安定性をリアルタイムで可視化し、研究者が歩行パターンを理解できるようにします。

#### 表示内容

1. **CV値の推移グラフ**
   - 最大60データポイント（約2分間）を表示
   - 目標ライン（5%）を破線で表示
   - 現在値を強調表示

2. **グラフの特徴**
   - Y軸: CV値（0-15%）
   - X軸: 時間（60秒前から現在まで）
   - 色分け:
     - CV < 5%: 緑色（安定）
     - 5% ≤ CV < 8%: 黄色（やや不安定）
     - CV ≥ 8%: 赤色（不安定）

#### UI統合
データモニターモードの心拍数カードの下に配置され、歩行の安定性を常時監視できます。

### 3. 無意識的テンポ調整アルゴリズム

#### 調整戦略

1. **快適ゾーン内（±5%）**
   - 微細な調整（±1%）でゆっくりと目標を上げる
   - 1分以上安定している場合は調整率を1.5倍に

2. **実際のSPMが高すぎる場合**
   - 目標を少し上げて追従（調整率30%）

3. **実際のSPMが低すぎる場合**
   - 目標を少し下げて合わせる（調整率50%）
   - 安定歩行時間をリセット

## データフォーマット

### CSV出力への追加フィールド

```csv
CV_Percent,Stability_Score,Responsiveness_Score
5.2,0.8,1.2
4.8,0.8,1.2
```

### 個人パラメータの保存形式

```json
{
  "responsivenessScore": 1.2,
  "stabilityPreference": 1.5,
  "maxComfortableSpm": 110.0,
  "baselineSpm": 100.0,
  "learningDate": "2024-01-20T10:30:00.000Z"
}
```

## 使用方法

### 初回使用時
1. 通常通り実験を実施
2. システムが自動的にデータを収集・学習
3. 次回以降、学習したパラメータが自動適用

### パラメータの確認
`AdaptiveTempoController.getControlStatus()`で現在の制御状態を確認可能

### パラメータのリセット
新しいユーザーの場合は`initialize()`で初期化

## 期待される効果

1. **個人差への対応**
   - ユーザーごとの反応特性に合わせた最適な誘導

2. **安定性の向上**
   - CV値のリアルタイム監視による歩行の質の向上

3. **研究データの充実**
   - 詳細な安定性メトリクスの記録

## 今後の拡張可能性

1. **機械学習モデルの統合**
   - より高度なパターン認識
   - 予測的な調整

2. **長期学習**
   - 複数セッションにわたる学習
   - 季節変動や体調変化への対応

3. **グループ分析**
   - 年齢層別の最適パラメータ
   - 歩行能力別の調整戦略