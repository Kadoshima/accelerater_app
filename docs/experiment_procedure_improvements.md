# 歩行解析実験手順の改善提案書

## 更新履歴
- 2024/06/04: 新機能実装完了（反応研究対応、加速度データ収集、個別対応機能）

## 1. 現状の課題と改善の方向性

### 1.1 実験デザインの科学的厳密性

#### 現状の課題
- **自由歩行フェーズ（5分）**: 
  - 被験者の疲労や慣れによる影響を考慮していない
  - 環境要因（天候、路面状況）の記録がない
  - 歩行開始直後の不安定な期間が含まれている可能性

#### 改善提案
1. **ウォームアップ期間の追加**
   - 本実験開始前に2-3分のウォームアップ歩行
   - データ収集はするが、分析からは除外
   - 被験者の歩行リズムの安定化を待つ

2. **環境条件の記録**
   - 実験開始時に環境条件を入力する画面を追加
   - 天候、路面状況、時間帯、場所（屋内/屋外）など
   - これらをメタデータとしてCSVに含める

3. **ベースライン測定の改善**
   - 最後の2分間のデータのみを使用してベースラインSPMを計算
   - 外れ値除去アルゴリズムの実装（四分位範囲法など）

### 1.2 フェーズ遷移の最適化

#### 現状の課題
- **固定的な遷移条件**: 
  - すべての被験者に同じ基準を適用
  - 個人差（年齢、体力、歩行能力）を考慮していない

#### 改善提案
1. **適応的な安定性判定**
   ```
   安定性スコア = 1 - (|実測SPM - 目標SPM| / 目標SPM)
   
   遷移条件:
   - 若年者（<40歳）: 30秒間スコア>0.95
   - 中年者（40-60歳）: 45秒間スコア>0.93
   - 高齢者（>60歳）: 60秒間スコア>0.90
   ```

2. **段階的なピッチ増加**
   - 初期増加: +3 BPM（慣れるまで）
   - 標準増加: +5 BPM（現状維持）
   - 限界付近: +2 BPM（より細かい限界測定）

### 1.3 データ品質の向上

#### 現状の課題
- **歩数検出の信頼性**: 
  - 単一のアルゴリズムに依存
  - 歩行以外の動き（立ち止まり、方向転換）の識別が不十分

#### 改善提案
1. **マルチアルゴリズムアプローチ**
   - ピーク検出法（現状）
   - ゼロクロス法
   - 機械学習ベース（事前学習モデル）
   - 3つの結果を統合して最終判定

2. **動作分類の追加**
   - 歩行/走行/静止/方向転換の分類
   - 各動作の継続時間を記録
   - 純粋な歩行時間のみでSPMを計算

## 2. ユーザビリティの改善

### 2.1 実験中のフィードバック強化

#### 改善提案
1. **視覚的フィードバック**
   - リアルタイムSPMグラフの常時表示
   - 目標SPMとの差を色で表現（緑:±3、黄:±5、赤:±10）
   - 安定性ゲージの追加

2. **音声ガイダンス**
   - フェーズ遷移の事前予告（「あと10秒で次のフェーズです」）
   - ペース調整の指示（「少し速く」「ペースを維持」）
   - 励ましのメッセージ（「順調です」「もう少しです」）

3. **振動フィードバック**
   - メトロノームと同期した振動（iOS対応）
   - ペースのずれを振動パターンで通知

### 2.2 実験前後のサポート

#### 改善提案
1. **実験前チェックリスト**
   - センサー接続状態の確認
   - GPS信号強度の確認
   - バッテリー残量の警告
   - 必要な権限の確認

2. **実験後レポート**
   - 実験サマリーの即時表示
   - 達成したSPM、安定性スコア、総歩数
   - 前回との比較（改善点、記録更新など）

## 3. データ分析機能の追加

### 3.1 リアルタイム分析の拡張

#### 改善提案
1. **歩行変動性の分析**
   - ストライド間隔の変動係数（CV）
   - 歩行の対称性指標
   - 疲労度の推定

2. **心拍変動解析**
   - R-R間隔の変動
   - 運動強度と心拍の相関
   - 回復時間の測定

### 3.2 オフライン分析機能

#### 改善提案
1. **トレンド分析**
   - 複数回の実験データの比較
   - 長期的な改善/低下の可視化
   - 個人別の最適ペース推定

2. **エクスポート機能の強化**
   - 研究用の詳細CSVフォーマット
   - グラフ画像のエクスポート
   - 統計レポートの自動生成

## 4. 技術的な改善

### 4.1 データ収集の最適化

#### 改善提案
1. **適応的サンプリング**
   - 安定歩行時: 200ms間隔
   - 遷移期/不安定時: 50ms間隔
   - バッテリー節約モード: 500ms間隔

2. **データ圧縮**
   - センサーデータのリアルタイム圧縮
   - 差分エンコーディングの使用
   - ストレージ使用量を約60%削減

### 4.2 同期とバックアップ

#### 改善提案
1. **増分同期**
   - 実験中の定期的な部分アップロード
   - ネットワーク切断時の自動再開
   - ローカルとクラウドの整合性チェック

2. **多重バックアップ**
   - ローカルストレージ（primary）
   - iCloud/Google Drive（secondary）
   - 研究用サーバー（tertiary）

## 5. 実装優先順位

### Phase 1（即座に実装可能）
1. ウォームアップ期間の追加
2. 環境条件の記録機能
3. 視覚的フィードバックの強化
4. 実験前チェックリスト

### Phase 2（中期的な改善）
1. 適応的な安定性判定
2. マルチアルゴリズム歩数検出
3. 音声ガイダンス
4. 実験後レポート機能

### Phase 3（長期的な開発）
1. 機械学習ベースの動作分類
2. 高度な分析機能
3. 研究者向けの管理ダッシュボード
4. 多施設共同研究対応

## 6. 検証とバリデーション

### 6.1 精度検証
- ビデオ解析との比較検証
- 医療グレードの歩行分析システムとの相関
- 異なる歩行パターンでの検証

### 6.2 ユーザビリティテスト
- 高齢者を含む多様な被験者での使用性評価
- 実験手順の理解度調査
- フィードバックの有効性検証

## 7. 倫理的配慮

### 7.1 データプライバシー
- GPSデータの匿名化オプション
- 個人識別情報の暗号化
- データ削除機能の実装

### 7.2 被験者の安全
- 過度なペース増加の防止機能
- 心拍数による安全域監視
- 緊急停止ボタンの改善

## 8. 2024年6月実装済み機能

### 8.1 反応研究対応機能
音への反応を調査するための新しい実験モードを実装しました。

#### 実装内容
1. **実験タイプの選択**
   - 従来型実験：順序固定、個別対応
   - 反応研究実験：ランダム順序、反応測定

2. **ランダムフェーズ機能**
   - 3つのフェーズタイプ：
     - 自由歩行
     - ピッチキープ（現状維持）
     - ピッチ上昇（5-20%のランダム増加）
   - フェーズの順序をランダム化
   - 各フェーズの時間長さをランダム化（1-3分の範囲）

3. **反応時間計測**
   - 音刺激（テンポ変更）から歩行変化までの時間を自動計測
   - 90%以上の追従率で反応完了と判定
   - ミリ秒単位での記録

### 8.2 歩行安定性メトリクス
#### 実装内容
1. **変動係数（CV）の計算**
   - ストライド間隔の変動を定量化
   - リアルタイムで計算・表示
   - 歩行の安定性を客観的に評価

2. **GaitStabilityAnalyzer クラス**
   - 変動係数の計算
   - 左右対称性の評価（将来実装予定）

### 8.3 個別対応機能（適応的テンポ制御）
#### 実装内容
1. **AdaptiveTempoController**
   - 個人の反応に応じてテンポを自動調整
   - 無意識的な歩行誘導のための微細な調整
   - 安定性と反応性のバランスを考慮

2. **ON/OFFスイッチ**
   - 実験設定画面で個別対応機能の有効/無効を切り替え可能
   - 研究目的に応じて選択

3. **学習機能**
   - セッションデータから個人パラメータを学習
   - 反応性スコア、安定性重視度、最大快適SPMを自動調整

### 8.4 加速度センサーデータの完全記録
#### 実装内容
1. **1時間分のデータバッファリング**
   - 最大360,000データポイント（100Hz × 3600秒）
   - リングバッファによるメモリ効率化
   - 約36MBのメモリ使用量

2. **自動保存機能**
   - 実験終了時にCSVファイルとして自動保存
   - ファイル名：`accelerometer_[条件]_[被験者ID]_[タイムスタンプ].csv`
   - 保存場所：アプリのドキュメントディレクトリ/experiment_data

3. **データ内容**
   - タイムスタンプ
   - 3軸加速度（X, Y, Z）
   - 3軸ジャイロ（X, Y, Z）
   - 合成加速度
   - その他のセンサーデータ

### 8.5 UIの改善
#### 実装内容
1. **実験タイプ選択画面**
   - 視覚的に分かりやすいカード形式
   - アイコンと説明文で選択を支援

2. **リアルタイムメトリクス表示**
   - 変動係数（CV）の表示
   - 反応時間の表示
   - データ収集状況の表示

3. **ランダム実験プレビュー**
   - 生成されたフェーズシーケンスを事前確認
   - 各フェーズの時間長さを表示

### 8.6 データ構造の拡張
#### 実装内容
1. **実験セッションの拡張**
   - ExperimentType（traditional/randomOrder）
   - RandomPhaseInfo（フェーズ情報）
   - 反応時間の記録
   - 歩行安定性メトリクス

2. **CSVデータの拡張**
   - 変動係数（CV）
   - 反応時間
   - 適応制御の状態
   - ランダムフェーズ情報

---

これらの改善により、音への反応研究と長期データ収集が可能になりました。実装の優先順位は研究目的と利用可能なリソースに応じて調整可能です。