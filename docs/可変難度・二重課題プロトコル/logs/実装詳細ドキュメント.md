# 可変難度・二重課題プロトコル 実装詳細ドキュメント

## 概要
本ドキュメントは、可変難度・二重課題プロトコルの実装において作成された各コンポーネントの詳細を記録したものです。

実装期間: 2025-01-02
実装ブランチ: `feature/dual-task-protocol`

## 目次
1. [Phase 0: 高優先度コンポーネント](#phase-0-高優先度コンポーネント)
2. [Phase 1: 基盤システム準備](#phase-1-基盤システム準備)
3. [Phase 2: N-backモジュール](#phase-2-n-backモジュール)
4. [Phase 3: 実験制御システム統合](#phase-3-実験制御システム統合)

---

## Phase 0: 高優先度コンポーネント

### 0.1 AdaptiveTempoService
**ファイル**: `/lib/services/adaptive_tempo_service.dart`

#### 概要
最小二乗線形予測アルゴリズムを用いた適応的テンポ制御サービス。位相誤差を予測し、リアルタイムでBPMを調整します。

#### 主要機能
- **線形予測モデル**: 過去10歩分の位相データから将来の位相誤差を予測
- **BPM更新式**: `BPM_t+1 = BPM_t + kφ·e_t + kT·(e_t - e_t-1)`
- **ゲインパラメータ**: 
  - kφ = 0.35（位相ゲイン）
  - kT = 0.10（周期ゲイン）

#### 主要メソッド
```dart
// サービスの初期化
void initialize(double initialBpm)

// リアルタイムBPM更新
double updateBpm({
  required DateTime clickTime,
  required DateTime heelStrikeTime,
})

// デバッグ情報の取得
Map<String, dynamic> getDebugInfo()
```

#### 実装の特徴
- 最小二乗法による線形回帰で位相の傾向を把握
- 予測値と実測値を組み合わせた補正（7:3の比率）
- BPMを60-200の範囲に制限して安全性を確保

---

### 0.2 PhaseErrorEngine
**ファイル**: `/lib/services/phase_error_engine.dart`

#### 概要
リアルタイムで位相誤差を計算し、RMSEと収束時間を評価するエンジン。

#### 主要機能
- **位相誤差計算**: `e_t = click_t - heelstrike_t`（秒単位）
- **RMSE計算**: `RMSE_φ = √(Σ(e_t)²/n)`
- **収束時間検出**: `|SPM-target| < 3 SPM`となるまでの時間を自動検出

#### 主要メソッド
```dart
// エンジンの初期化
void initialize(double targetSpm)

// 位相誤差の記録
void recordPhaseError({
  required DateTime clickTime,
  required DateTime heelStrikeTime,
  required double currentSpm,
})

// 統計情報の取得
Map<String, dynamic> getStatistics()

// CSV出力用データの生成
Map<String, dynamic> getExportData()
```

#### データ管理
- 最大300件（5分間）の位相誤差を保持
- 収束判定は10秒間のウィンドウで実施
- 収束後も継続的にRMSEを更新

---

### 0.3 AudioConflictResolver
**ファイル**: `/lib/services/audio_conflict_resolver.dart`

#### 概要
メトロノームクリックとN-back音声の衝突を検出し、自動的に再生時刻を調整するサービス。

#### 主要機能
- **衝突検出**: 200ms以内の音声イベントを衝突と判定
- **自動シフト**: 衝突時は±100msで時刻を調整
- **予測機能**: メトロノームBPMから次回クリック時刻を予測

#### 主要メソッド
```dart
// リゾルバーの初期化
void initialize(double metronomeBpm)

// N-back音声のスケジューリング
DateTime scheduleNBackAudio({
  required DateTime originalTime,
  required int duration,
})

// 衝突統計の取得
Map<String, dynamic> getConflictStatistics()
```

#### 衝突回避アルゴリズム
1. メトロノームクリックとの衝突チェック
2. 既存のN-backイベントとの重複チェック
3. 前後どちらにシフトするかを自動判定
4. 衝突ログを記録して統計情報を提供

---

### 0.4 ExtendedDataRecorder
**ファイル**: `/lib/services/extended_data_recorder.dart`

#### 概要
基本のSensorDataRecorderを拡張し、可変難度・二重課題プロトコル用の追加メトリクスを記録。

#### 主要機能
- **deltaC計算**: `CV_fixed - CV_baseline`
- **deltaR計算**: `CV_fixed - CV_adaptive`
- **拡張メトリクス**: RMSE_phi、Tc、phase_correction_gain、tempo_adjustment

#### 拡張CSVフォーマット
```csv
timestamp_ms, timestamp_iso, condition, is_adaptive, current_spm, current_cv, 
delta_c, delta_r, rmse_phi, convergence_time_tc, phase_correction_gain, 
tempo_adjustment, additional_data_json
```

#### 実装の特徴
- 条件ごとのCV値を自動追跡
- ベースラインCVを基準にdeltaC/deltaRを計算
- PhaseErrorEngineと連携してRMSE/Tcを記録

---

## Phase 1: 基盤システム準備

### 1.1 プロジェクト設定
**ファイル**: `/pubspec.yaml`

#### 追加した依存関係
```yaml
flutter_tts: ^3.8.5      # Text-to-Speech for N-back
speech_to_text: ^6.6.0   # 音声認識（オプション）
audioplayers: ^5.2.1     # 音声再生制御
```

---

### 1.2 データモデル設計
**ファイル**: `/lib/models/nback_models.dart`

#### 実装したモデル

##### NBackConfig
N-back課題の設定を管理
```dart
- nLevel: int (0, 1, 2)
- sequenceLength: int
- intervalMs: int
- language: String
- speechRate: double
```

##### NBackResponse
個々の応答を記録
```dart
- sequenceIndex: int
- presentedDigit: int
- respondedDigit: int?
- isCorrect: bool
- timestamp: DateTime
- reactionTimeMs: int?
- responseType: ResponseType
```

##### NBackSession
セッション全体を管理
```dart
- sessionId: String
- config: NBackConfig
- sequence: List<int>
- responses: List<NBackResponse>
- startTime: DateTime
- endTime: DateTime?
```

##### NBackPerformance
パフォーマンス統計を計算
```dart
- totalTrials: int
- correctResponses: int
- accuracy: double
- averageReactionTime: double
- rollingAccuracy: Map<int, double>
```

##### DualTaskExperimentSession
実験セッション全体を管理
```dart
- cognitiveLoad: CognitiveLoad
- tempoControl: TempoControl
- nbackSession: NBackSession?
- baselineSpm: double
- deltaC: double?
- deltaR: double?
- rmsePhi: double?
- convergenceTimeTc: double?
```

---

## Phase 2: N-backモジュール

### 2.1 NBackSequenceGenerator
**ファイル**: `/lib/services/nback_sequence_generator.dart`

#### 概要
N-back課題用の数字列を生成するジェネレーター。

#### 主要機能
- **ターゲット一致率制御**: デフォルト30%の一致率
- **0-back特別処理**: 特定のターゲット数字を検出する課題
- **正答計算**: 生成した数字列に対する正答を自動計算

#### アルゴリズム
1. マッチ位置をランダムに決定
2. 最初のn個はランダムに生成
3. マッチ位置ではn個前と同じ数字
4. 非マッチ位置では異なる数字を生成

---

### 2.2 TTSService
**ファイル**: `/lib/services/tts_service.dart`

#### 概要
Flutter TTSをラップし、N-back課題用に最適化された音声合成サービス。

#### 主要機能
- **多言語対応**: 日本語/英語の数字読み上げ
- **タイミング制御**: AudioConflictResolverと連携
- **設定管理**: 速度、音量、ピッチの調整

#### 数字読み上げヘルパー
```dart
class DigitSpeechHelper {
  // 日本語: 'いち', 'に', 'さん'...
  // 英語: 'one', 'two', 'three'...
}
```

---

### 2.3 NBackResponseCollector
**ファイル**: `/lib/services/nback_response_collector.dart`

#### 概要
N-back課題の応答を収集するシステム。音声認識とボタン入力の両方に対応。

#### 主要機能
- **音声認識**: 日本語の数字を認識
- **ボタン入力**: フォールバック用のUI入力
- **タイムアウト処理**: 2秒でタイムアウト
- **反応時間測定**: ミリ秒単位で記録

#### 日本語数字認識
```dart
// 認識パターン
'ゼロ', 'れい', 'まる' → 0
'いち', 'ひとつ' → 1
// ... など
```

---

### 2.4 UIコンポーネント

#### NBackDisplayWidget
**ファイル**: `/lib/presentation/widgets/nback_display_widget.dart`

##### 機能
- アニメーション付き数字表示
- 正解/不正解のフィードバック
- 進行状況バー
- 1-9の数字入力グリッド

##### デザイン
- Material Design 3準拠
- レスポンシブレイアウト
- アクセシビリティ対応

#### NBackSettingsScreen
**ファイル**: `/lib/presentation/screens/nback_settings_screen.dart`

##### 設定項目
- N-backレベル（0/1/2）
- 数字列の長さ（10-60）
- 表示間隔（1-4秒）
- 読み上げ言語
- 音声入力のON/OFF

---

## Phase 3: 実験制御システム統合

### 3.1 ExperimentConditionManager
**ファイル**: `/lib/services/experiment_condition_manager.dart`

#### 概要
6条件（2×3）の実験デザインを管理し、ラテン方格法で順序を決定。

#### 実験条件
```dart
// テンポ制御（2条件）
- Adaptive（適応的）
- Fixed（固定）

// 認知負荷（4条件）
- None（なし）
- 0-back
- 1-back
- 2-back
```

#### ラテン方格法
- 6×6のラテン方格を使用
- 被験者番号 % 6 で行を選択
- カウンターバランスを保証

---

### 3.2 ExperimentFlowController
**ファイル**: `/lib/services/experiment_flow_controller.dart`

#### 概要
6分構成の実験ブロックを管理するフロー制御システム。

#### 実験フェーズ（6分構成）
1. **Baseline（60秒）**: 自由歩行、メトロノームなし
2. **同期フェーズ（120秒）**: メトロノームに同期
3. **Challenge 1（60秒）**: テンポ変化＋認知課題
4. **Challenge 2（60秒）**: 継続
5. **安定観察（30秒）**: 歩行安定性の観察

#### 主要機能
- フェーズ自動遷移
- 残り時間カウントダウン
- 休憩タイマー（条件により1-3分）
- 各フェーズの指示表示

---

### 3.3 DataSynchronizationService
**ファイル**: `/lib/services/data_synchronization_service.dart`

#### 概要
異なるサンプリングレートのデータを同期・管理するサービス。

#### 対応データ
- **IMUデータ**: 100Hz
- **心拍データ**: 3秒間隔（Polar H10仕様）
- **N-back応答**: イベントベース
- **位相誤差**: イベントベース

#### 主要機能
```dart
// IMUデータの記録
void recordIMUData({
  required String sensorId,
  required IMUData data,
})

// 心拍データの記録（3秒更新対応）
void recordHeartRateData({
  required HeartRateData data,
})

// 同期統計の取得
SynchronizationStatistics getStatistics()
```

#### データ同期アルゴリズム
1. 全データに相対タイムスタンプを付与
2. 最大1000件（10秒分）のバッファリング
3. ストリームで リアルタイム配信
4. 同期エラーの自動計算

---

## 実装上の工夫点

### 1. 位相予測アルゴリズム
- 過去データから線形トレンドを抽出
- 予測値と実測値をブレンドして安定性向上

### 2. 音声衝突回避
- 200ms以内を衝突と判定
- 前後の空き時間を考慮して最適な方向にシフト

### 3. データ同期
- 相対時間を使用してドリフトを防止
- Polar H10の3秒更新に特化した同期エラー計算

### 4. 実験フロー
- 状態遷移を自動化して実験者の負担軽減
- 各フェーズで適切な指示を自動表示

### 5. エラーハンドリング
- 音声認識失敗時はボタン入力にフォールバック
- データ欠損時も実験継続可能な設計

---

## 今後の課題

1. **単体テストの作成**
   - AdaptiveTempoServiceのアルゴリズムテスト
   - NBackSequenceGeneratorの統計的検証

2. **統合テストの実施**
   - 6条件すべての動作確認
   - データ記録の完全性検証

3. **パフォーマンス最適化**
   - 大量データ時のメモリ使用量削減
   - リアルタイム処理の遅延最小化

4. **UI/UXの改善**
   - 実験者用ダッシュボード
   - リアルタイムモニタリング画面