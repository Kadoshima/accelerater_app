# 歩行解析アプリ - 現在の実験手順書

## 1. 実験モードの概要

本アプリには3つの実験モードがあります：

### 1.1 通常モード
- 標準的なデータモニタリングと記録モード
- ユーザーが手動でメトロノームを制御し、データを記録
- 構造化された実験フェーズなし

### 1.2 無音データ収集モード
- 音声フィードバックなしで自然な歩行データを収集
- SPM（毎分歩数）、歩数、GPS位置情報を記録
- 2秒ごとにデータを記録
- メトロノームや音声による合図なし

### 1.3 本実験モード
- 3つの明確なフェーズを持つ構造化された実験
- 歩行の安定性に基づく自動フェーズ遷移
- ペーシングガイダンスのためのメトロノーム使用
- 最も包括的なデータ収集モード

## 2. 本実験モードのフェーズ詳細

### フェーズ1: 自由歩行
- **継続時間**: 5分間（300秒）
- **目的**: ベースラインの歩行リズムを確立
- **動作**:
  - 被験者は音声合図なしで自然に歩行
  - システムが自然な歩行SPMを監視・記録
  - 過去10秒間の平均SPMを計算
  - 5の倍数に丸める（例：87→85 SPM）
- **遷移**: 5分後に自動的にフェーズ2へ移行

### フェーズ2: ピッチ調整
- **継続時間**: 可変（最低60秒間の安定歩行）
- **目的**: 歩行をメトロノームに同期させる
- **動作**:
  - メトロノームがフェーズ1のベースラインSPMで開始
  - 被験者はメトロノームに合わせて歩行ペースを調整
  - システムが実際のSPMと目標SPMの差を監視
  - 安定性閾値：目標±5 SPM
  - ユーザーが一貫して異なるペースで歩く場合、メトロノームのテンポを調整
- **遷移**: 60秒間の安定歩行後にフェーズ3へ移行

### フェーズ3: ピッチ増加
- **継続時間**: ユーザーが停止するか、ペースを維持できなくなるまで継続
- **目的**: 歩行速度を段階的に増加させる
- **動作**:
  - 初期目標：ベースラインSPM + 5
  - 60秒間の安定歩行ごとに5 SPMずつ増加
  - ペースを維持できない場合（10秒間目標より10 SPM以上遅い）、5 SPM減少
  - 達成した最大SPMと増加回数を記録
- **遷移**: 実験が手動で停止されたときに終了

## 3. データ収集手順

### リアルタイムデータ収集（実験中100msごと）
- **加速度計データ**: X、Y、Z軸と大きさ
- **ジャイロスコープデータ**: X、Y、Z軸
- **心拍数**: 心拍センサーが接続されている場合
- **歩行メトリクス**: SPM、歩数、信頼性スコア
- **GPS位置**: 緯度、経度、高度、速度
- **実験メタデータ**: フェーズ、目標BPM、経過時間

### 時系列データ記録（2秒間隔）
- タイムスタンプ（Unixミリ秒および読み取り可能な形式）
- 現在の実験フェーズ
- 目標BPM/SPM
- 実際の歩行SPM
- フェーズ安定時間（秒）
- ピッチ増加回数
- 音声再生ステータス
- GPS座標

## 4. 収集されるセンサーデータ

### IMUデータ（M5Stackデバイスから）
- **加速度計**: 3軸加速度（G-force）
  - X軸：横方向の動き
  - Y軸：垂直方向の動き（歩数検出の主要軸）
  - Z軸：前後方向の動き
  - 大きさ：結合された加速度ベクトル
- **ジャイロスコープ**: 3軸角速度（度/秒）

### 心拍数データ
- BPM（毎分心拍数）Bluetooth心拍センサーから
- 3秒ごとに更新
- 最近の読み取り値のバッファを維持

### GPSデータ
- 緯度と経度の座標
- 高度（メートル）
- 速度（m/s）
- 位置情報サービスが有効な場合に収集

## 5. メトロノームの使用

### メトロノーム設定
- **テンポ範囲**: 60-150 BPM（5 BPM刻み）
- **2つの実装**:
  - ネイティブメトロノーム（プラットフォーム固有、より正確）
  - Dartメトロノーム（クロスプラットフォームフォールバック）
- **振動サポート**: Androidでオプションの触覚フィードバック

### 実験での使用
- **フェーズ1**: メトロノームなし（自然歩行）
- **フェーズ2**: ベースラインSPMで開始し、同期をガイド
- **フェーズ3**: 歩行速度に挑戦するため段階的に増加
- ユーザーが一貫して異なるペースで歩く場合は自動調整

## 6. データ保存とアップロード

### ローカルストレージ
- 包括的なヘッダーを持つCSV形式
- ファイル名形式：`{experiment_type}_{subject_id}_{timestamp}.csv`
- アプリのドキュメントディレクトリに保存

### CSV構造
```
# Experiment_Summary
- 被験者ID、実験日時、ベースピッチ、最大到達BPM
- ピッチ増加回数、継続時間、データポイント数

# Time_Series_Data
- タイムスタンプ、フェーズ、経過時間、目標BPM、歩行SPM
- 安定時間、ピッチ増加回数、音声ステータス
- GPS座標（緯度、経度、高度、速度）
```

### Azureアップロード
- 実験後にAzure Blob Storageへ自動アップロード
- 認証にSASトークンを使用
- コンテナ：`accelerationdata`
- リトライメカニズム：2秒の遅延で3回試行
- ユーザーへの成功/失敗通知

## 7. 実験パラメータと条件

### タイミングパラメータ
- **自由歩行期間**: 300秒（5分）
- **安定性閾値**: 60秒（1分）
- **ピッチ差閾値**: 10 BPM
- **ピッチ増加ステップ**: 5 BPM
- **データ記録間隔**: 2秒
- **センサーサンプリング**: 100ms

### フェーズ遷移条件
- **自由歩行→ピッチ調整**: 300秒後
- **ピッチ調整→ピッチ増加**: 60秒間の安定歩行後（±5 SPM）
- **ピッチ増加**: 60秒間の安定性ごと→+5 SPM
- **ピッチ減少**: 10秒間差が10 SPM以上→-5 SPM

## 8. 特別な機能

### バックグラウンドサービス
- アプリがバックグラウンドになってもデータ収集を継続
- SharedPreferencesに実験状態を保存
- 中断された実験を再開可能

### リアルタイム分析
- ピーク検出アルゴリズムを使用したSPM計算
- トレンド除去と標準偏差しきい値処理
- 歩数検出の信頼性スコアリング
- データ平滑化のための移動平均

### ユーザー通知
- フェーズ遷移のアナウンス
- テンポ変更の通知
- 安定性達成のアラート
- データアップロードの確認

---

## 改善検討事項（今後のディスカッション用）

### 実験デザイン
- フェーズ1（自由歩行）の5分間は適切か？
- 安定性の判定基準（±5 SPM、60秒）は妥当か？
- ピッチ増加の刻み（5 BPM）は最適か？

### データ収集
- 2秒間隔のデータ記録は十分か？
- 追加で収集すべきセンサーデータはあるか？
- GPS精度の向上方法

### ユーザビリティ
- 実験中のフィードバック方法の改善
- 音声ガイダンスの追加
- 視覚的な進行状況表示

### 技術的改善
- バッテリー消費の最適化
- データ圧縮とストレージ効率
- オフライン時のデータ同期戦略